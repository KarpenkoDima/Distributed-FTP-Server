# ============================================================================
# HAProxy Configuration for FTP Load Balancing
# ============================================================================
# ‚úÖ –ü–†–û–í–ï–†–ï–ù–û –ò –†–ê–ë–û–¢–ê–ï–¢!
# –≠—Ç–æ—Ç –∫–æ–Ω—Ñ–∏–≥ —Ä–µ—à–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å FTP proxy, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å nginx

global
    log 127.0.0.1 local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    
    # üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 2m

defaults
    mode tcp            # üéØ TCP mode - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è FTP!
    log global
    retries 3
    timeout connect 5s      # –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    timeout client 1h       # üïê –î–æ–ª–≥–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
    timeout server 1h       # üïê –î–æ–ª–≥–∏–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    option tcplog           # üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    balance roundrobin      # üîÑ –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏

# ============================================================================
# üéõÔ∏è FTP CONTROL CONNECTIONS (Port 21)
# ============================================================================
# –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –≥–¥–µ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã (USER, PASS, LIST, etc.)

listen ftp_control
    bind *:21
    
    # üîê STICKY SESSIONS - –ö–õ–Æ–ß–ï–í–ê–Ø –§–ò–ß–ê!
    # –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∞ —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–µ—Ä –¥–ª—è control –∏ data
    stick-table type ip size 100k expire 30m
    stick on src    # –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ IP –∫–ª–∏–µ–Ω—Ç–∞
    
    # üñ•Ô∏è Backend —Å–µ—Ä–≤–µ—Ä—ã —Å health checks
    server ftp-server-1 ftp-server-1:21 check inter 5s fall 3 rise 2
    server ftp-server-2 ftp-server-2:21 check inter 5s fall 3 rise 2  
    server ftp-server-3 ftp-server-3:21 check inter 5s fall 3 rise 2

# ============================================================================
# üì° FTP DATA CONNECTIONS (Passive Mode Ports)
# ============================================================================
# –≠—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤ –∏ directory listings

listen ftp_data
    bind *:50000-50010      # üéØ –î–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ –¥–ª—è PASV mode
    
    # ÔøΩ –¢–ê –ñ–ï sticky table - –∫–ª–∏–µ–Ω—Ç –ø–æ–ø–∞–¥–µ—Ç –Ω–∞ —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–µ—Ä!
    stick-table type ip size 100k expire 30m
    stick on src
    
    # üñ•Ô∏è Backend —Å–µ—Ä–≤–µ—Ä—ã –ë–ï–ó health checks
    # ‚ùó –í–ê–ñ–ù–û: Data –ø–æ—Ä—Ç—ã –Ω–µ —Å–ª—É—à–∞—é—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ, –ø–æ—ç—Ç–æ–º—É check —É–±–∏—Ä–∞–µ–º
    server ftp-server-1 ftp-server-1
    server ftp-server-2 ftp-server-2  
    server ftp-server-3 ftp-server-3

# ============================================================================
# üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================================================

# –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ HAProxy
listen stats_page
    bind *:8404             # http://your-server:8404/stats
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    
    # üîê –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å!)
    stats auth admin:admin123
    
    # üìà –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 'stats admin' —Ç—Ä–µ–±—É–µ—Ç —É—Å–ª–æ–≤–∏—è –≤ HAProxy 2.3.x
    stats admin if TRUE
    stats show-desc HAProxy FTP Load Balancer

# ============================================================================
# üîß –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫)
# ============================================================================

# –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –±–æ–ª—å—à–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤, –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ listen —Å–µ–∫—Ü–∏–∏:

# listen ftp_data_extended
#     bind *:50011-50050          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ 40 –ø–æ—Ä—Ç–æ–≤
#     stick-table type ip size 100k expire 30m
#     stick on src
#     server ftp-server-1 ftp-server-1
#     server ftp-server-2 ftp-server-2
#     server ftp-server-3 ftp-server-3

# ============================================================================
# üìù –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
# ============================================================================

# –î–ª—è rsyslog –¥–æ–±–∞–≤—å—Ç–µ –≤ /etc/rsyslog.conf:
# $ModLoad imudp
# $UDPServerRun 514
# $UDPServerAddress 127.0.0.1
# local0.* /var/log/haproxy.log

# ============================================================================
# üéØ –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –≠–¢–û–ì–û –†–ï–®–ï–ù–ò–Ø:
# ============================================================================
# 
# ‚úÖ Sticky Sessions - –∫–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ
# ‚úÖ Health Checks - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤  
# ‚úÖ TCP Mode - –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º FTP
# ‚úÖ –ü—Ä–æ—Å—Ç–æ–π –º–∞–ø–ø–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤ - –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
# ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
# ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–æ—Ä—Ç–æ–≤/—Å–µ—Ä–≤–µ—Ä–æ–≤
# ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å - –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ enterprise —Ä–µ—à–µ–Ω–∏–µ
#
# üöÄ –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç nginx, HAProxy "–ø–æ–Ω–∏–º–∞–µ—Ç" —Å–ø–µ—Ü–∏—Ñ–∏–∫—É FTP –∏–∑ –∫–æ—Ä–æ–±–∫–∏!